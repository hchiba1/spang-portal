#!/usr/bin/perl
use strict;

my $CONTENT = "";

my $FILE = "library$ENV{PATH_INFO}";
if (-f $FILE) {
    $CONTENT = `/home/chiba/etc/spang/bin/spang mbgd /home/chiba/www_spang/html/$FILE -q`;
    if ($CONTENT =~ s/^(# .*\n)//m) {
	$CONTENT = $1 . "\n" . $CONTENT;
    }
    $CONTENT =~ s/^#\S.*\n//mg;
} elsif (-f "$FILE.rq") {
    $CONTENT = `cat $FILE.rq`;
}

if ($ENV{HTTP_ACCEPT} =~ /^text\/html/) {
    print "Content-type: text/html\n\n";
    print "<html>\n";
    
    print "<head>\n";
    print "<title>SPARQL query</title>";
    print '<link rel="stylesheet" href="/codemirror-5.30.0/lib/codemirror.css">';
    print '<script src="/codemirror-5.30.0/lib/codemirror.js"></script>';
    print '<script src="/codemirror-5.30.0/mode/sparql/sparql.js"></script>';
    print "</head>\n";
    
    print '<body>';
    print '<textarea id="code" name="code">';
    print $CONTENT;
    print '</textarea>';
    print '<script>var editor = CodeMirror.fromTextArea(document.getElementById("code"), {mode: "application/sparql-query"}); </script>';
    print '</body>';
    print '</html>';
} else {
    print "Content-type: text/plain\n\n";
    print $CONTENT;
}
