#!/usr/bin/perl
use strict;

my $arg = $ENV{PATH_INFO};

my $file = "";
if (-f "library$arg") {
    $file = "library$arg";
} elsif (-f "library$arg.rq") {
    $file = "library$arg.rq";
}

my $content = "";
if ($file) {
    $content = `/home/chiba/etc/spang/bin/spang mbgd /home/chiba/www_spang/html/$file -q`;
    if ($content =~ s/^(# .*\n)//m) {
	# $content = $1 . $content;
	$content = $1 . "\n" . $content;
    }
    $content =~ s/^#\S.*\n//mg;
}

if ($ENV{HTTP_ACCEPT} =~ /^text\/html/) {
    print "Content-type: text/html\n\n";
    print "<html>\n";
    
    print "<head>\n";
    print "<title>SPARQL query</title>";
    print '<link rel="stylesheet" href="/codemirror-5.30.0/lib/codemirror.css">';
    print '<script src="/codemirror-5.30.0/lib/codemirror.js"></script>';
    print '<script src="/codemirror-5.30.0/mode/sparql/sparql.js"></script>';
    print "</head>\n";
    
    print '<body>';
    print '<textarea id="code" name="code">';
    print $content;
    print '</textarea>';
    print '<script>var editor = CodeMirror.fromTextArea(document.getElementById("code"), {mode: "application/sparql-query"}); </script>';
    print '</body>';
    print '</html>';
} else {
    print "Content-type: text/plain\n\n";
    print $content;
}
